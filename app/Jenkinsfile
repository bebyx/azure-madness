#!/usr/bin/env groovy

node {
    checkout scm

    final acrCredId = 'ACR_CREDS'

    // Define the workspace
    def workspace = pwd()
    def appImage

    stage('Build app image') {
        appImage = docker.build("app:${env.BUILD_ID}",
                                    "-f ${workspace}/app/Dockerfile ${workspace}/app")
    }

    stage('Push app image to ACR') {
        // Login to Azure Container Registry
        docker.withRegistry('https://bebyxregistry.azurecr.io', acrCredId) {
            // Push image
            appImage.push()
            appImage.push('latest')
        }
    }

    stage('Login into AZ as AKS User') {
        withCredentials([
                usernamePassword(
                        credentialsId: 'AKS_CREDS',
                        usernameVariable: 'AKS_USERNAME',
                        passwordVariable: 'AKS_PASSWORD'),
                string(credentialsId: 'TENANT_ID', variable: 'TENANT_ID')
        ]) {
            sh 'az login --service-principal -u $AKS_USERNAME -p $AKS_PASSWORD --tenant $TENANT_ID'
            sh 'az aks get-credentials --resource-group Artem-Candidate --name aks'
        }
    }
}